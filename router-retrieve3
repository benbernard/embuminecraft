os.loadAPI('/benpi')

b = benpi.BenPI.new()
sorter = peripheral.wrap("top");

ref_chest = 1
retr_chest = 2
ref_repo = 3

function pulse(direction)
   redstone.setOutput(direction, false);
   redstone.setOutput(direction, true);
   sleep(.5)
   redstone.setOutput(direction, false);
end

function onOffBottom()
   bottom = true
   while true do
      redstone.setOutput("bottom", bottom)
      sleep(2)
      bottom = not bottom
   end
end

function waitForEnter()
   read()
end

function waitForRefObject()
   while true do
      local chest_contents
      chest_contents = sorter.list(ref_chest)
      if(next(chest_contents) == nil) then
         sleep(.5)
      else
         local id,num
         for id,num in pairs(chest_contents) do
            print(id)
            sorter.extract(ref_chest,id,retr_chest,num)
            pulse("back")
            sleep(1)
            sorter.extract(retr_chest,id,ref_repo,num)
         end
      end
   end
end


print("ROUTER-RETRIEVE")
print("Press [enter] to exit.")
parallel.waitForAny(waitForRefObject, waitForEnter, onOffBottom)
